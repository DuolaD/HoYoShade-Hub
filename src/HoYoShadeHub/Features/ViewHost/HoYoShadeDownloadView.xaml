<UserControl x:Class="HoYoShadeHub.Features.ViewHost.HoYoShadeDownloadView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:lang="using:HoYoShadeHub.Language"
             xmlns:github="using:HoYoShadeHub.Core.Metadata.Github"
             x:DefaultBindMode="OneWay"
             mc:Ignorable="d">

    <Grid Loaded="Grid_Loaded">
        <Image HorizontalAlignment="Center"
               VerticalAlignment="Center"
               Source="ms-appx:///Assets/Image/UI_CutScene_1130320101A.png"
               Stretch="UniformToFill" />
        <Rectangle HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"
                   Fill="{ThemeResource ControlOnImageFillColorDefaultBrush}" />

        <!-- Installation Status Panel (Top Right) -->
        <StackPanel Margin="0,48,48,0"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Spacing="8">
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="12,8">
                <StackPanel Spacing="6">
                    <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_InstallStatus}"
                               FontSize="12"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    
                    <!-- HoYoShade Status -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <FontIcon Grid.Column="0" 
                                  FontSize="14" 
                                  FontFamily="Segoe Fluent Icons"
                                  Margin="0,0,8,0"
                                  Glyph="{x:Bind IsHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolToInstallGlyphConverter}}" 
                                  Foreground="{x:Bind IsHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolToInstallColorConverter}}" />
                        <TextBlock Grid.Column="1"
                                   Text="HoYoShade"
                                   FontSize="13" />
                    </Grid>
                    
                    <!-- OpenHoYoShade Status -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <FontIcon Grid.Column="0" 
                                  FontSize="14" 
                                  FontFamily="Segoe Fluent Icons"
                                  Margin="0,0,8,0"
                                  Glyph="{x:Bind IsOpenHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolToInstallGlyphConverter}}" 
                                  Foreground="{x:Bind IsOpenHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolToInstallColorConverter}}" />
                        <TextBlock Grid.Column="1"
                                   Text="OpenHoYoShade"
                                   FontSize="13" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Language Selector moved below installation status -->
            <ComboBox Name="ComboBox_Language"
                      MinWidth="200"
                      HorizontalAlignment="Stretch"
                      SelectionChanged="ComboBox_Language_SelectionChanged" />
        </StackPanel>

        <StackPanel Margin="48,40,48,80" VerticalAlignment="Center" Spacing="8">
            <TextBlock FontSize="24" 
                       Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                       Text="{x:Bind lang:Lang.HoYoShadeDownloadView_Title}" />

            <!-- Version Selection -->
            <StackPanel Spacing="4">
                <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_SelectVersion}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <ComboBox ItemsSource="{x:Bind Versions}" 
                          SelectedItem="{x:Bind SelectedVersion, Mode=TwoWay}"
                          MinWidth="240">
                    <ComboBox.ItemTemplate>
                        <DataTemplate x:DataType="github:GithubRelease">
                            <TextBlock>
                                <Run Text="{x:Bind Name}" />
                                <Run Text="{x:Bind LatestVersionTag, Mode=OneWay}" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                            </TextBlock>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_LatestVersionTip}"
                           TextWrapping="Wrap"
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           FontSize="11" />
                
                <!-- Preview Channel Toggle -->
                <ToggleSwitch IsOn="{x:Bind EnablePreviewChannel, Mode=TwoWay}"
                              OffContent="{x:Bind lang:Lang.SettingPage_JoinPreviewReleaseChannel}"
                              OnContent="{x:Bind lang:Lang.SettingPage_JoinPreviewReleaseChannel}"
                              Margin="0,2,0,0" />
            </StackPanel>

            <!-- Flavor Selection -->
            <StackPanel Spacing="4">
                <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_SelectType}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <StackPanel Spacing="8">
                    <StackPanel Spacing="3">
                        <CheckBox Content="{x:Bind lang:Lang.HoYoShadeDownloadView_Option_HoYoShade}" 
                                  IsChecked="{x:Bind IsHoYoShadeSelected, Mode=TwoWay}"
                                  IsEnabled="{x:Bind IsHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolReversedConverter}}" />
                        <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_HoYoShade_Description}"
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                   FontSize="11"
                                   Margin="28,0,0,0" />
                    </StackPanel>
                    <StackPanel Spacing="3">
                        <CheckBox Content="{x:Bind lang:Lang.HoYoShadeDownloadView_Option_OpenHoYoShade}" 
                                  IsChecked="{x:Bind IsOpenHoYoShadeSelected, Mode=TwoWay}"
                                  IsEnabled="{x:Bind IsOpenHoYoShadeInstalled, Mode=OneWay, Converter={StaticResource BoolReversedConverter}}" />
                        <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_OpenHoYoShade_Description}"
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                   FontSize="11"
                                   Margin="28,0,0,0" />
                    </StackPanel>
                </StackPanel>
            </StackPanel>

            <!-- Server Selection -->
            <StackPanel Spacing="4">
                <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_DownloadServer}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <ComboBox ItemsSource="{x:Bind DownloadServers}" 
                          SelectedItem="{x:Bind SelectedDownloadServer, Mode=TwoWay}" 
                          MinWidth="240" />
            </StackPanel>

            <!-- Download and Refresh buttons -->
            <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,12,0,0">
                <Button Content="{x:Bind DownloadButtonText, Mode=OneWay}" 
                        Command="{x:Bind DownloadCommand}" 
                        Style="{ThemeResource AccentButtonStyle}" 
                        IsEnabled="{x:Bind CanDownload, Mode=OneWay}" />
                
                <Button Command="{x:Bind RefreshVersionsCommand}"
                        IsEnabled="{x:Bind CanRefresh, Mode=OneWay}"
                        Visibility="{x:Bind ShowRefreshButton, Mode=OneWay}"
                        ToolTipService.ToolTip="{x:Bind lang:Lang.Common_Refresh}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon FontSize="14" Glyph="&#xE72C;" />
                        <TextBlock Text="{x:Bind lang:Lang.Common_Refresh}" />
                    </StackPanel>
                </Button>
                
                <!-- Pause/Resume Button - Hidden when paused to avoid duplicate Continue button -->
                <Button Command="{x:Bind PauseResumeCommand}"
                        Visibility="{x:Bind ShowPauseResumeButton, Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon FontSize="14" Glyph="&#xE769;" />
                        <TextBlock Text="{x:Bind PauseResumeButtonText, Mode=OneWay}" />
                    </StackPanel>
                </Button>
                
                <!-- Stop Button - Available during both downloading and paused states -->
                <Button Command="{x:Bind StopCommand}"
                        Visibility="{x:Bind IsControlButtonsVisible, Mode=OneWay}"
                        IsEnabled="{x:Bind CanStop, Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon FontSize="14" Glyph="&#xE71A;" />
                        <TextBlock Text="{x:Bind lang:Lang.DownloadGamePage_Stop}" />
                    </StackPanel>
                </Button>
            </StackPanel>

            <StackPanel Spacing="4">
                <ProgressBar Value="{x:Bind DownloadProgress, Mode=OneWay}" Maximum="100" />
                <!-- Status and progress info -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    
                    <!-- Left: Status message -->
                    <TextBlock Grid.Column="0"
                               Text="{x:Bind StatusMessage, Mode=OneWay}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    
                    <!-- Right: Speed and percentage -->
                    <TextBlock Grid.Column="1"
                               Text="{x:Bind SpeedAndProgress, Mode=OneWay}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               HorizontalAlignment="Right" />
                </Grid>
            </StackPanel>

        </StackPanel>

        <!-- Start Button -->
        <Button Height="40"
                Margin="0,0,80,48"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                BorderThickness="0"
                Command="{x:Bind StartCommand}"
                IsEnabled="{x:Bind CanStart, Mode=OneWay}"
                Style="{ThemeResource AccentButtonStyle}"
                CornerRadius="8,20,20,8">
             <TextBlock Margin="4,0,8,0" FontSize="14" Text="{x:Bind lang:Lang.HoYoShadeDownloadView_Next}" />
        </Button>
        
        <!-- Import from Local Button -->
        <StackPanel Margin="48,0,0,48"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Bottom"
                    Spacing="8">
            <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_ImportFromLocal}"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       FontSize="12" />
            <Button Command="{x:Bind ImportFromLocalCommand}"
                    IsEnabled="{x:Bind CanImport, Mode=OneWay}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon FontSize="14" Glyph="&#xE8E5;" />
                    <TextBlock Text="{x:Bind lang:Lang.HoYoShadeDownloadView_SelectPackage}" />
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>
</UserControl>
